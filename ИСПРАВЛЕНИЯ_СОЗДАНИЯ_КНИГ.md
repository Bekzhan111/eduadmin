# Исправления Проблем с Созданием Книг

## Проблемы, которые были обнаружены

### 1. ❌ Ошибка с типом данных price
**Проблема:** `Error: invalid input syntax for type integer: "4999.89"`
**Причина:** В базе данных поле `price` имеет тип `INTEGER`, но код отправлял значения с плавающей точкой

### 2. ❌ Кнопка на английском языке
**Проблема:** Кнопка "Send to Moderation" отображалась на английском
**Причина:** Отсутствие локализации в интерфейсе

### 3. ❌ Недостаточная валидация цены
**Проблема:** Пользователь мог ввести дробные числа, что приводило к ошибкам
**Причина:** Отсутствие проверки на целочисленность

## Исправления

### ✅ 1. Исправлен тип данных price
**Файл:** `src/app/dashboard/books/create/page.tsx`

**До:**
```typescript
price: parseFloat(formData.price),
```

**После:**
```typescript
price: Math.round(parseFloat(formData.price)), // Convert to integer for database
```

**Также добавлена валидация:**
```typescript
// Validate that price can be converted to integer (no decimals for now)
const priceValue = parseFloat(formData.price);
if (!Number.isInteger(priceValue)) {
  return 'Цена должна быть целым числом (без копеек). Например: 5000, 2800';
}
```

### ✅ 2. Переведена кнопка на русский язык
**Файл:** `src/app/dashboard/books/page.tsx`

**До:**
```typescript
Send to Moderation
```

**После:**
```typescript
Отправить на модерацию
```

**Также улучшены другие кнопки модератора:**
- "Одобрить Книгу" → "Одобрить"
- Кнопки стали более компактными

### ✅ 3. Улучшена валидация формы
**Файл:** `src/app/dashboard/books/create/page.tsx`

Добавлена проверка:
- Цена должна быть целым числом
- Подсказка для пользователя о правильном формате цены
- Конвертация дробных значений в целые числа

## Процесс создания книги (исправленный)

### Для автора:
1. **Создание книги** (`/dashboard/books/create`)
   - Заполнение формы с валидацией
   - Цена указывается целым числом (например: 2500, 3000)
   - Автоматическая генерация `base_url` из названия
   - Статус автоматически устанавливается как "Moderation"

2. **Отправка на модерацию** (`/dashboard/books`)
   - Книга автоматически попадает в статус "Moderation"
   - Кнопка "Отправить на модерацию" для черновиков
   - Возможность редактирования только черновиков

### Для модератора:
1. **Просмотр книг на модерации** (`/dashboard/books`)
   - Видят все книги со статусом "Moderation"
   - Компактные кнопки действий
   - Возможность одобрения или отклонения

2. **Действия модератора:**
   - **"Одобрить"** - переводит книгу в статус "Approved"
   - **"Отклонить"** - возвращает книгу в статус "Draft" с указанием причины

### Для суперадминистратора:
1. **Активация книг** (`/dashboard/books`)
   - Видят все книги
   - Могут активировать одобренные книги (статус "Active")

## Типы данных в базе данных

### Таблица `books`
```sql
CREATE TABLE books (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    grade_level TEXT,
    course TEXT,
    category TEXT,
    status TEXT CHECK (status IN ('Draft', 'Moderation', 'Approved', 'Active')) DEFAULT 'Draft',
    author_id UUID REFERENCES auth.users(id),
    moderator_id UUID REFERENCES auth.users(id),
    price INTEGER, -- ⚠️ ВАЖНО: INTEGER, не DECIMAL!
    pages_count INTEGER,
    base_url TEXT NOT NULL UNIQUE,
    language TEXT DEFAULT 'Русский',
    cover_image TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

## Рекомендации

### ✅ Для авторов:
- Указывайте цену целыми числами (5000, 2800, 1500)
- Не используйте копейки в ценах
- Заполняйте все обязательные поля

### ✅ Для модераторов:
- Все книги на модерации отображаются автоматически
- Используйте компактные кнопки для одобрения/отклонения
- При отклонении указывайте конкретную причину

### ✅ Для разработчиков:
- Всегда используйте `Math.round()` для цен перед отправкой в БД
- Добавляйте валидацию на фронтенде
- Учитывайте ограничения типов данных PostgreSQL

## Тестирование

### Сценарий 1: Создание книги автором
1. Войти как автор
2. Перейти в `/dashboard/books/create`
3. Заполнить форму с ценой "2500"
4. Нажать "Создать и отправить на модерацию"
5. **Ожидаемый результат:** Книга создана со статусом "Moderation"

### Сценарий 2: Модерация книги
1. Войти как модератор
2. Перейти в `/dashboard/books`
3. Найти книгу со статусом "Moderation"
4. Нажать "Одобрить"
5. **Ожидаемый результат:** Книга переведена в статус "Approved"

### Сценарий 3: Валидация цены
1. Войти как автор
2. Попытаться создать книгу с ценой "4999.89"
3. **Ожидаемый результат:** Показана ошибка валидации

## Статусы книг

| Статус | Описание | Кто может видеть | Действия |
|--------|----------|------------------|----------|
| **Draft** | Черновик | Автор | Редактировать, Отправить на модерацию, Удалить |
| **Moderation** | На модерации | Модераторы, Автор | Одобрить, Отклонить |
| **Approved** | Одобрено | Суперадмин | Активировать |
| **Active** | Активна | Все пользователи | Читать, Добавить в школу |

## Результат

✅ **Исправлено:**
- Ошибка с типом данных price
- Локализация интерфейса
- Валидация формы создания книги
- Процесс модерации работает корректно

✅ **Улучшено:**
- UX для авторов и модераторов
- Понятные сообщения об ошибках
- Компактный интерфейс управления

✅ **Предотвращено:**
- Ошибки базы данных из-за неправильных типов
- Путаница с языком интерфейса
- Создание книг с некорректными данными 